<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitwise operations</title>
    <style>
        body {
            font-family: sans-serif;
        }

        input {
            font-size: 1.25rem;
            width: auto;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        #errors {
            display: none;
            height: 25px;
            font-size: 1.25rem;
            border: solid red 2px;
            border-radius: 5px;
            height: auto;
            max-width: min-content;
        }

        #errors > h4 {
            margin: 10px;
        }

        label {
            display: block;
            margin-bottom: 20px;
            text-decoration: underline;
            letter-spacing: .5px;
            font-size: 1.1rem;
        }

        #output {
            font-size: 1.25rem;
            min-height: max-content;
        }

        #bitops {
            font-size: 1.3rem;
        }
    </style>
</head>

<body>
    <center>
        <main>
            <h2>Преобразование в систему счисления</h2>

            <input placeholder="число" id="numberInput">
            <input placeholder="основание" type="number" id="radix" min="2" max="36" value="2">
            <div id="output"></div>

            <h2>Битовые операции</h2>

            <label for="bits">2 значения разделенные пробелами</label>
            <input type="text" id="bits">

            <div id="bitops">
                <div id="bitand"></div>
                <div id="bitor"></div>
                <div id="xor"></div>
                <div id="lsh"></div>
                <div id="rsh"></div>
            </div>
            <h2>Рассчет операции</h2>
            <input type="text" id="evaluate" placeholder="выражение">
            <p id="eval_result"></p>

            <div id="errors"></div>
        </main>
    </center>
    <script>
        function useDebounce(func, time = 500) {
            if (typeof func != "function")
                throw new Error(`First argument is type: ${typeof func}, want function.\n Maybe wrap with () => {}`);
            let timeout;
            (function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args)
                }, time);
            })();
        }

        const numberInput = document.getElementById("numberInput");
        const radixInput = document.getElementById("radix");
        const numberOutput = document.getElementById("output");

        const bitwiseOpsInput = document.getElementById("bits");
        const errorsContainer = document.getElementById("errors");
        const bitops = document.getElementById("bitops");
        const bitand = document.getElementById("bitand");
        const bitor = document.getElementById("bitor");
        const xor = document.getElementById("xor");
        const lsh = document.getElementById("lsh");
        const rsh = document.getElementById("rsh");

        const evalResult = document.getElementById("eval_result")
        const evalInput = document.getElementById("evaluate");
        const EvalPattern = /^[\s<>/*\-+()^&~|xo0-9a-f]+$/gi;

        var radix = 2;
        const isNumberRegex = /\b0[xob][a-f0-9]+\b|\d+/ig;

        function clearError(ttl = 1500) {
            setTimeout(() => {
                errorsContainer.innerHTML = null;
                errorsContainer.style.display = "none";
            }, ttl);
        }

        function castInteger(x) {
            numberOutput.textContent = Number(x || 0).toString(parseInt(radix)).toUpperCase();
        }

        function displayBitwiseOps(x, y) {
            bitand.textContent = `${x} & ${y} = ${x & y}`;
            bitor.textContent = `${x} | ${y} = ${x | y}`;
            xor.textContent = `${x} ^ ${y} = ${x ^ y}`;
            lsh.textContent = `${x} << ${y} = ${x << y}`;
            rsh.textContent = `${x} >> ${y} = ${x >> y}`;
        }

        radixInput.addEventListener("input", (event) => {
            useDebounce(() => {
                var x = numberInput.value.match(isNumberRegex);
                if (x == null) {
                    errorsContainer.style.display = "block";
                    errorsContainer.innerHTML = "<h4>Нужно ввести число</h4>";
                    numberOutput.textContent = null;
                    clearError();
                    return;
                }
                let value = event.target.value;
                if (value < 2 || value > 36) {
                    errorsContainer.style.display = "block";
                    errorsContainer.innerHTML = "<h4>Основание СС должно быть от 2 до 36</h4>";
                    numberOutput.textContent = null;
                    clearError();
                    return;
                }
                radix = parseInt(value);
                castInteger(x[0]);
            })
        });

        numberInput.addEventListener("input", (event) => {
            useDebounce(() => {
                var x = event.target.value.match(isNumberRegex);
                if (x == null) {
                    errorsContainer.style.display = "block";
                    errorsContainer.innerHTML = "<h4>Нужно ввести число</h4>";
                    clearError();
                    return;
                }
                castInteger(x[0]);
            })
        });

        bitwiseOpsInput.addEventListener("input", (event) => {
            useDebounce(() => {
                var ops = event.target.value.match(isNumberRegex);
                console.log(ops);
                if (ops == null || ops.length < 2 || ops.length > 2) {
                    errorsContainer.style.display = "block";
                    errorsContainer.innerHTML = "<h4>Необходимо 2 числа для битовой операции</h4>";
                    for (const bitop of bitops.children) {
                        bitop.textContent = null;
                    }
                    clearError();
                    return;
                } else
                    displayBitwiseOps(ops[0], ops[1]);
            })
        });

        evalInput.addEventListener("input", (event) => {
            useDebounce(() => {
                try {
                    errorsContainer.innerHTML = null;
                    let expr = event.target.value.match(EvalPattern);
                    if (expr == null) {
                        evalResult.innerHTML = null;
                        return;
                    }
                    console.log(expr[0]);
                    if (expr == null) {
                        evalResult.innerHTML = null;
                        return;
                    }
                    console.log(expr[0]);
                    evalResult.textContent = eval(expr[0]);
                } catch (error) {
                    evalResult.textContent = null;
                    errorsContainer.style.display = "block";
                    errorsContainer.insertAdjacentHTML("beforeend", "<h4>Неправильно введено выражение</h4>");
                    clearError();
                    console.error("In expression: ", error);
                    return;
                }
            }, 1000)
        });

    </script>
</body>

</html>