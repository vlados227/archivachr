<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Websites Availability</title>
    <style>

        body {
            font-family: sans-serif;
        }

         form {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-direction: column;
            width: 50vw;
            margin-bottom: 30px;
        }

        form textarea {
            width: inherit;
            font-size: .9rem;
            min-height: 30vh;
        }

        .result {
            display: block;
            border: 1px grey solid;
            border-radius: 5px;
            margin-bottom: 20px;
            padding: 10px;
            max-width: 50vw;
            word-wrap: break-word;
        }

        [type="submit"] {
            min-width: 20%;
            padding: 5px;
            font-size: 1.2rem;
        }

        label {
            font-weight: bold;
        }

        [type="number"] {
            font-size: 1rem;
        }

        .err::before {
            content: 'üî¥';
        }

        @media (max-width: 700px) {
            form {
                width: 90%;
            }
            .result {
                width: 90%;
            }
        }

    </style>
</head>
<body>
    <main>
        <center>
            <form>
                <h1>–°–ø–∏—Å–æ–∫ —Å–∞–π—Ç–æ–≤</h1>
                <textarea name="websites" id="websites"></textarea>
                <label for="timeout">–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (—Å–µ–∫.)</label>
                <input id="timeout" value="10" type="number">
                <input type="submit">
            </form>

            <div id="container">

            </div>
        </center>
    </main>
    
    <script>
        const form = document.querySelector("form");
        const textfield = document.querySelector("textarea");
        const container = document.getElementById("container");
        const t = document.getElementById("timeout");
        var listURL = [];
        var pool = [];

        localStorage.lastItem ?? localStorage.setItem("lastItem", "");
        if (localStorage.lastItem != '') textfield.value = localStorage.lastItem;
       
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            clearResults();
            listURL = textfield.value.split(/\s/);
            localStorage.lastItem = textfield.value;
            console.log(listURL);

            for (const url of listURL) {
                const p = new Promise((resolve, reject) => {
                    const ctl = new AbortController();
                    const signal = ctl.signal;
                    const timeout = setTimeout(() => ctl.abort("–ó–∞–ø—Ä–æ—Å –∑–∞–Ω—è–ª —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ"), 1000 * t.value);
                    fetch(url, {signal, method: "GET", redirect: "follow"})
                        .then(r => {
                            if (r.ok) {
                                clearTimeout(timeout);
                                return resolve({url: r.url, status: r.status, meaning: r.statusText});
                            } else {
                                clearTimeout(timeout);
                                return reject({message: r.statusText, url: r.url, code: r.status})
                            }
                        })
                        .catch(message => {
                            return reject({message, url: url});
                        })
                })
                pool.push(p)
            }   

            Promise.allSettled(pool).then(p => p.forEach(r => {
                switch (r.status) {
                    case "fulfilled":
                        console.info(r.value.url, r.value.status, r.value.meaning);
                        appendResult(r.value, false);
                        break;
                    case "rejected":
                        console.warn(r.reason.message, r.reason.url)
                        appendResult(r.reason, true);
                        break;
                }
            }))
            pool = listURL = [];
            console.clear();
       }) //end form listener

       function clearInput() {
            textfield.value = null;
       }

       function appendResult(props, failed) {
            const resultElement = document.createElement("div");
            resultElement.classList.add("result");
            if (failed) {
                resultElement.classList.add("err");
                resultElement.innerHTML = `<b>URL:</b> <u>${props.url}</u> <b>–ø—Ä–∏—á–∏–Ω–∞:</b> ${props.code ?? ''} ${props.message.message ?? props.message}`;
            } else {
                resultElement.innerHTML = `<b>URL:</b> <u>${props.url}</u> <b>c—Ç–∞—Ç—É—Å:</b> ${props.status}  ${props.meaning}`;
            }

            container.appendChild(resultElement);
       }

       function clearResults() {
            while (container.children.length != 0) {
                container.removeChild(container.lastChild);
            }
       }

    </script>
</body>
</html>